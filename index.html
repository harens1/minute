<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдХрд╛рд░реНрдпрдкрд╛рд▓рд┐рдХрд╛рдХреЛ рдмреИрдардХ рдирд┐рд░реНрдгрдп</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
@page{
    size:A4;
    margin-top:25mm;
    margin-left:25.4mm;   /* 1 inch */
    margin-right:5mm;     /* exactly 5mm */
    margin-bottom:25.4mm;
}

body{
    font-family:"Kalimati","Mangal","Noto Sans Devanagari",sans-serif;
    margin:0;
    background:#e5e7eb;
    line-height:1.75;
}

/* Toolbar */
.toolbar{
    position:fixed;
    top:0; left:0; right:0;
    background:#1f2937;
    padding:8px;
    text-align:center;
    z-index:1000;
}
.toolbar button{
    background:#ffffff;
    border:1px solid #cbd5e1;
    padding:6px 14px;
    margin:3px;
    font-size:14px;
    border-radius:4px;
    cursor:pointer;
}
.toolbar button:hover{background:#f1f5f9;}

/* Page */
.container{
    width:210mm;
    min-height:297mm;
    background:#fff;
    margin:80px auto 0;
    padding-top:25mm;
    padding-left:25.4mm;
    padding-right:5mm;
    padding-bottom:25.4mm;
    box-sizing:border-box;
}

/* Headings */
h2{
    font-weight:normal;
    margin-bottom:18px;
}

/* Inputs */
input, textarea, select{
    font-family:inherit;
    font-size:16px;
    border:none;
    outline:none;
    background:none;
}

/* Name input */
input.name{
    min-width:160px;
    border-bottom:1px dotted #000;
}

/* Paragraph style */
.justify{
    text-align:justify;
    text-indent:32px; /* one tab */
}

/* Textarea */
textarea{
    width:100%;
    resize:none;
    overflow:hidden;
}

/* Sections */
.section{margin-top:20px;}

.item{
    display:flex;
    gap:6px;
    margin-bottom:6px;
}
.number{width:28px;}
.delete{
    cursor:pointer;
    color:#b91c1c;
    font-size:14px;
    padding-left:4px;
}

/* Attendance */
.centerTitle{
    text-align:center;
    margin-bottom:6px;
}

table{
    width:100%;
    border-collapse:collapse;
}
th, td{
    border:1px solid #000;
    padding:8px;
}
th{
    text-align:center;
    font-weight:normal;
}

/* Clean dropdown */
select{
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
}

/* Print */
@media print{
    .toolbar,.delete{display:none;}
    body{background:none;}
    .container{margin:0;}
    select{appearance:none;}
}
</style>
</head>

<body>

<div class="toolbar">
    <button onclick="location.href='index.html'">ЁЯПа рдореБрдЦреНрдп рдкреЗрдЬ</button>
    <button onclick="location.href='files.html'">ЁЯУЪ рдлрд╛рдЗрд▓ рд╕реВрдЪреА</button>
    <button onclick="addProposal()">тЮХ рдкреНрд░рд╕реНрддрд╛рд╡</button>
    <button onclick="addDecision()">тЮХ рдирд┐рд░реНрдгрдп</button>
    <button onclick="addRow()">тЮХ рдЙрдкрд╕реНрдерд┐рддрд┐ рдкрдВрдХреНрддрд┐</button>
    <button onclick="window.print()">ЁЯСБ View</button>
    <button onclick="window.print()">ЁЯЦи Print</button>
    <button onclick="downloadPDF()">ЁЯУД PDF</button>
    <button onclick="saveToDisk()">ЁЯТ╛ рд╕реЗрдн</button>
    <button id="authBtn" onclick="toggleLogin()">ЁЯФР рд▓рдЧрдЗрди</button>
    <button id="changePwBtn" style="display:none;" onclick="changePassword()">ЁЯФС рдкрд╛рд╕рд╡рд░реНрдб рдкрд░рд┐рд╡рд░реНрддрди</button>
    <button id="manageUsersBtn" style="display:none;" onclick="adminManageUsers()">ЁЯСе рдпреБрдЬрд░ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</button>
</div>

<div class="container" id="content">

<h2 contenteditable="true">рдХрд╛рд░реНрдпрдкрд╛рд▓рд┐рдХрд╛рдХреЛ рдмреИрдардХ рдирд┐рд░реНрдгрдп</h2>

<p><u>
рдмреИрдардХ рдорд┐рддрд┐ (рд╡рд┐.рд╕рдВ.) :
<input type="text" id="meetingDate"></u>
</p>

<p class="justify">
рдЖрдЬ рдорд┐рддрд┐ <strong><span id="dateInline"></span></strong> рдЧрддреЗ рдпрд╕
<select>
  <option>рдирдЧрд░рдкрд╛рд▓рд┐рдХрд╛рдХрд╛</option>
  <option>рдЧрд╛рдЙрдБрдкрд╛рд▓рд┐рдХрд╛рдХрд╛</option>
</select>
<select>
  <option>рдирдЧрд░ рдкреНрд░рдореБрдЦ</option>
  <option>рдЕрдзреНрдпрдХреНрд╖</option>
</select>
рд╢реНрд░реА<input type="text" class="name" placeholder="рдирд╛рдо"> рдЬреНрдпреВрдХреЛ рдЕрдзреНрдпрдХреНрд╖рддрд╛рдорд╛
рдирд┐рдореНрди рд╕рджрд╕реНрдпрд╣рд░реБрдХреЛ рдЙрдкрд╕реНрдерд┐рддрд┐рдорд╛ рддрдкрд╕рд┐рд▓ рдмрдореЛрдЬрд┐рдордХреЛ рдкреНрд░рд╕реНрддрд╛рд╡рд╣рд░реБ рдЙрдкрд░ рдЫрд▓рдлрд▓ рдЧрд░реА 
<select>
  <option>рд╕рд░реНрдмрд╕рдореНрдордд рд░реБрдкрдорд╛ рдирд┐рд░реНрдгрдп рдЧрд░рд┐рдпреЛ ред </option>
  <option>рдирд┐рд░реНрдгрдп рдЧрд░рд┐рдпреЛ ред</option>
</select>
</p>

<div class="section">
<div class="centerTitle"><strong>рдЙрдкрд╕реНрдерд┐рддрд┐ :</strong></div>

<table id="attendance">
<tr>
    <th style="width:25%;">рдкрдж</th>
    <th style="width:45%;">рдкрджрд╛рдзрд┐рдХрд╛рд░реА / рд╕рджрд╕реНрдпрдХреЛ рдирд╛рдо</th>
    <th style="width:30%;">рд╣рд╕реНрддрд╛рдХреНрд╖рд░</th>
</tr>
</table>
</div>

<div class="section">
<strong>рдкреНрд░рд╕реНрддрд╛рд╡рд╣рд░реВ :</strong>
<div id="proposals"></div>
</div>

<div class="section">
<strong>рдирд┐рд░реНрдгрдпрд╣рд░реВ :</strong>
<div id="decisions"></div>
</div>

</div>

<script>
let pCount=0,dCount=0;

/* BS Date */
function todayBS(){
    const t=new Date();
    let y=t.getFullYear()+56,m=t.getMonth()+1+8,d=t.getDate()+16;
    if(d>30){d-=30;m++;}
    if(m>12){m-=12;y++;}
    const n=x=>x.toString().replace(/\d/g,v=>"режрезреирейрекрелремренреореп"[v]);
    return n(y)+"/"+n(String(m).padStart(2,"0"))+"/"+n(String(d).padStart(2,"0"));
}

function autoGrow(e){
    e.style.height="auto";
    e.style.height=e.scrollHeight+"px";
}
function fullStop(t){
    t=t.trim();
    return t.endsWith("ред")?t:t+"ред";
}
function renumber(){
    [...proposals.children].forEach((e,i)=>e.querySelector(".number").innerText=(i+1)+".");
    [...decisions.children].forEach((e,i)=>e.querySelector(".number").innerText=(i+1)+".");
    pCount=proposals.children.length;
    dCount=decisions.children.length;
}
function addProposal(t=""){
    pCount++;
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<div class="number">${pCount}.</div>
    <textarea oninput="autoGrow(this)" onblur="this.value=fullStop(this.value)">${t}</textarea>
    <span class="delete" onclick="this.parentElement.remove();renumber()">ЁЯЧС</span>`;
    proposals.appendChild(d);
}
function addDecision(t=""){
    dCount++;
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<div class="number">${dCount}.</div>
    <textarea oninput="autoGrow(this)" onblur="this.value=fullStop(this.value)">рдкреНрд░рд╕реНрддрд╛рд╡ рдирдВ. ${dCount} рдорд╛рдерд┐ рдЫрд▓рдлрд▓ рдЧрд░реНрджрд╛ ${t}</textarea>
    <span class="delete" onclick="this.parentElement.remove();renumber()">ЁЯЧС</span>`;
    decisions.appendChild(d);
}
function addRow(){
    const r=attendance.insertRow();
    r.innerHTML=`<td contenteditable="true"></td>
    <td contenteditable="true"></td>
    <td contenteditable="true"></td>`;
}
function downloadPDF(){
    html2pdf().from(content).set({
        filename:"karyapalika_baithak_nirnaya.pdf",
        jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
    }).save();
}

function openDB(){
    return new Promise((resolve,reject)=>{
        const r=indexedDB.open("minute-files",2);
        r.onupgradeneeded=()=>{
            const db=r.result;
            if(!db.objectStoreNames.contains("settings")) db.createObjectStore("settings",{keyPath:"key"});
            if(!db.objectStoreNames.contains("users")) db.createObjectStore("users",{keyPath:"username"});
        };
        r.onsuccess=()=>resolve(r.result);
        r.onerror=()=>reject(r.error);
    });
}
function getSavedFolder(){
    return openDB().then(db=>new Promise((resolve)=>{
        const req=db.transaction("settings","readonly").objectStore("settings").get("saveDir");
        req.onsuccess=()=>resolve(req.result?req.result.handle:null);
        req.onerror=()=>resolve(null);
    }));
}
function setSavedFolder(handle){
    return openDB().then(db=>new Promise((resolve,reject)=>{
        const tx=db.transaction("settings","readwrite");
        tx.objectStore("settings").put({key:"saveDir",handle});
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
    }));
}
async function saveToDisk(){
    const pdf=await html2pdf().from(content).set({jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).toPdf().get("pdf");
    const blob=pdf.output("blob");
    const now=new Date();
    const filename="karyapalika_baithak_nirnaya_"+now.toISOString().slice(0,10)+".pdf";
    try{
        let dir=await getSavedFolder();
        if(!dir){
            if(window.showDirectoryPicker){
                dir=await showDirectoryPicker();
                await setSavedFolder(dir);
            }else if(window.showSaveFilePicker){
                const h=await showSaveFilePicker({suggestedName:filename,types:[{description:"PDF",accept:{"application/pdf":[".pdf"]}}]});
                const w=await h.createWritable();await w.write(blob);await w.close();
                alert("рд╕реЗрдн рднрдпреЛ");
                return;
            }else{
                const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();a.remove();
                alert("рдбрд╛рдЙрдирд▓реЛрдб рднрдП");
                return;
            }
        }
        const fh=await dir.getFileHandle(filename,{create:true});
        const w=await fh.createWritable();await w.write(blob);await w.close();
        alert("рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдлреЛрд▓реНрдбрд░рдорд╛ рд╕реЗрдн рднрдпреЛ");
    }catch(e){alert("рд╕реЗрдн рддреНрд░реБрдЯрд┐: "+e);}
}

async function hash(t){
    const data=new TextEncoder().encode(t);
    const buf=await crypto.subtle.digest("SHA-256",data);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function getUser(username){
    return openDB().then(db=>new Promise((resolve)=>{
        const req=db.transaction("users","readonly").objectStore("users").get(username);
        req.onsuccess=()=>resolve(req.result||null);
        req.onerror=()=>resolve(null);
    }));
}
function setUser(user){
    return openDB().then(db=>new Promise((resolve,reject)=>{
        const tx=db.transaction("users","readwrite");
        tx.objectStore("users").put(user);
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
    }));
}
async function ensureAdmin(){
    const u=await getUser("admin");
    if(!u){await setUser({username:"admin",role:"admin",hash:await hash("abcd@1")});}
}
function currentUser(){return localStorage.getItem("sessionUser")||null;}
async function updateUIAuth(){
    const u=currentUser();
    const authBtn=document.getElementById("authBtn");
    const cp=document.getElementById("changePwBtn");
    const mu=document.getElementById("manageUsersBtn");
    if(!authBtn) return;
    if(u){
        authBtn.textContent="ЁЯФУ рд▓рдЧрдЖрдЙрдЯ ("+u+")";
        if(cp) cp.style.display="";
        const rec=await getUser(u);
        if(mu) mu.style.display=rec&&rec.role==="admin"?"":"none";
    }else{
        authBtn.textContent="ЁЯФР рд▓рдЧрдЗрди";
        if(cp) cp.style.display="none";
        if(mu) mu.style.display="none";
    }
}
async function toggleLogin(){
    const u=currentUser();
    if(u){localStorage.removeItem("sessionUser");await updateUIAuth();alert("рд▓рдЧрдЖрдЙрдЯ рднрдпреЛ");return;}
    const username=prompt("рдпреБрдЬрд░ рдирд╛рдо:");
    const password=prompt("рдкрд╛рд╕рд╡рд░реНрдб:");
    if(!username||!password){alert("рдЕрд╡реИрдз рдЗрдирдкреБрдЯ");return;}
    const rec=await getUser(username);
    if(!rec){alert("рдпреБрдЬрд░ рднреЗрдЯрд┐рдПрди");return;}
    if(await hash(password)===rec.hash){localStorage.setItem("sessionUser",username);await updateUIAuth();alert("рд▓рдЧрдЗрди рднрдпреЛ");}
    else{alert("рдкрд╛рд╕рд╡рд░реНрдб рдорд┐рд▓реЗрди");}
}
async function changePassword(){
    const u=currentUser();
    if(!u){alert("рдкрд╣рд┐рд▓реЗ рд▓рдЧрдЗрди рдЧрд░реНрдиреБрд╣реЛрд╕реН");return;}
    const oldPw=prompt("рдкреБрд░рд╛рдиреЛ рдкрд╛рд╕рд╡рд░реНрдб:");
    const newPw=prompt("рдирдпрд╛рдБ рдкрд╛рд╕рд╡рд░реНрдб:");
    if(!oldPw||!newPw){alert("рдЕрд╡реИрдз рдЗрдирдкреБрдЯ");return;}
    const rec=await getUser(u);
    if(!rec){alert("рдпреБрдЬрд░ рднреЗрдЯрд┐рдПрди");return;}
    if(await hash(oldPw)!==rec.hash){alert("рдкреБрд░рд╛рдиреЛ рдкрд╛рд╕рд╡рд░реНрдб рдорд┐рд▓реЗрди");return;}
    rec.hash=await hash(newPw);
    await setUser(rec);
    alert("рдкрд╛рд╕рд╡рд░реНрдб рдкрд░рд┐рд╡рд░реНрддрди рднрдпреЛ");
}
async function adminManageUsers(){
    const u=currentUser();
    if(!u){alert("рдкрд╣рд┐рд▓реЗ рд▓рдЧрдЗрди рдЧрд░реНрдиреБрд╣реЛрд╕реН");return;}
    const me=await getUser(u);
    if(!me||me.role!=="admin"){alert("рдПрдбрдорд┐рди рдорд╛рддреНрд░");return;}
    const action=prompt("рдХрд╛рд░реНрдп ('add' / 'reset'):");
    if(action==="add"){
        const name=prompt("рдирдпрд╛рдБ рдпреБрдЬрд░ рдирд╛рдо:");
        const pw=prompt("рдирдпрд╛рдБ рдкрд╛рд╕рд╡рд░реНрдб:");
        if(!name||!pw){alert("рдЕрд╡реИрдз");return;}
        const exist=await getUser(name);
        if(exist){alert("рдпреБрдЬрд░ рдкрд╣рд┐рд▓реЗ рдиреИ рдЫ");return;}
        await setUser({username:name,role:"user",hash:await hash(pw)});
        alert("рдпреБрдЬрд░ рдердкрд┐рдпреЛ");
    }else if(action==="reset"){
        const name=prompt("рдпреБрдЬрд░ рдирд╛рдо:");
        const pw=prompt("рдирдпрд╛рдБ рдкрд╛рд╕рд╡рд░реНрдб:");
        if(!name||!pw){alert("рдЕрд╡реИрдз");return;}
        const rec=await getUser(name);
        if(!rec){alert("рдпреБрдЬрд░ рднреЗрдЯрд┐рдПрди");return;}
        rec.hash=await hash(pw);
        await setUser(rec);
        alert("рдкрд╛рд╕рд╡рд░реНрдб рд░рд┐рд╕реЗрдЯ рднрдпреЛ");
    }else{alert("рдЕрд╡реИрдз рдХрд╛рд░реНрдп");}
}

/* Init */
meetingDate.value=todayBS();
dateInline.innerText=todayBS();
ensureAdmin().then(updateUIAuth);
ensureAdmin().then(updateUIAuth);
</script>

</body>
</html>
